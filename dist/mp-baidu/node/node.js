"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,o)}return r}function r(t){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?e(Object(i),!0).forEach((function(e){o(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function o(t,e,r){return(e=i(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function i(e){var r=s(e,"string");return"symbol"==t(r)?r:r+""}function s(e,r){if("object"!=t(e)||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var i=o.call(e,r||"default");if("object"!=t(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(e)}var a=require("../parser");function n(t){var e;return((e=t.detail.y)-t.currentTarget.offsetTop<150||e<600)&&(e=t.currentTarget.offsetTop),e<30&&(e+=70),e-30}Component({data:{ctrl:{}},properties:{childs:Array,opts:Array},options:{addGlobalClass:!0},attached:function(){this.triggerEvent("add",this,{bubbles:!0,composed:!0})},detached:function(){this.root&&this.root._edit===this&&(this.root._edit=void 0)},methods:{editStart:function(t){var e=this;if(this.data.opts[5]){var r=t.currentTarget.dataset.i;this.data.ctrl["e"+r]||"simple"===this.data.opts[5]?("simple"===this.data.opts[5]&&(this.root._edit=this,this.i=r,this.cursor=this.getNode(r).text.length),this.root._mask.pop(),this.root._maskTap(),this.setData(o({},"ctrl.e"+r,2)),setTimeout((function(){e.setData(o({},"ctrl.e"+r,3))}),50)):(this.setData(o({},"ctrl.e"+r,1)),setTimeout((function(){e.root._mask.push((function(){e.setData(o({},"ctrl.e"+r,0))}))}),50),this.root._edit=this,this.i=r,this.cursor=this.getNode(r).text.length)}},editInput:function(t){var e=t.target.dataset.i,r=t.detail.value.replace(/ {2,}/,(function(t){for(var e=" ",r=1;r<t.length;r++)e+=" ";return e}));this.root._editVal("nodes["+(this.data.opts[7]+e).replace(/_/g,"].children[")+"].text",this.getNode(e).text,r),this.cursor=t.detail.cursor},editEnd:function(t){var e=t.target.dataset.i;this.setData(o({},"ctrl.e"+e,0)),this.root.setData(o({},"nodes["+(this.data.opts[7]+e).replace(/_/g,"].children[")+"].text",t.detail.value.replace(/ {2}/g,"  "))),void 0!==t.detail.cursor&&(this.cursor=t.detail.cursor)},insert:function(t){var e=this;setTimeout((function(){var r=e.i.split("_"),o=parseInt(r.pop()),i=r.join("_"),s=i?e.getNode(i).children:e.data.childs,a=s.slice(0);if(a[o])if(a[o].text){var n=a[o].text;if("text"===t.type)e.cursor?a[o].text=n.substring(0,e.cursor)+t.text+n.substring(e.cursor):a[o].text+=t.text;else{var c=[];e.cursor&&c.push({type:"text",text:n.substring(0,e.cursor)}),c.push(t),e.cursor<n.length&&c.push({type:"text",text:n.substring(e.cursor)}),a.splice.apply(a,[o,1].concat(c))}}else a.splice(o+1,0,t);else a.push(t);"_"===(i=e.data.opts[7]+i)[i.length-1]&&(i=i.slice(0,-1)),e.root._editVal("nodes"+(i?"["+i.replace(/_/g,"].children[")+"].children":""),s,a,!0),e.i=r.join("_")+"_"+(o+1)}),200)},remove:function(t){var e=t.split("_"),r=e.pop(),o=e.join("_"),i=o?this.getNode(o).children:this.data.childs,s=i.slice(0),a=s.splice(r,1)[0];if("img"===a.name||"video"===a.name||"audio"===a.name){var n=a.attrs.src;a.src&&(n=1===a.src.length?a.src[0]:a.src),this.root.triggerEvent("remove",{type:a.name,src:n})}this.root._edit=void 0,this.root._maskTap(),"_"===(o=this.data.opts[7]+o)[o.length-1]&&(o=o.slice(0,-1)),this.root._editVal("nodes"+(o?"["+o.replace(/_/g,"].children[")+"].children":""),i,s,!0)},nodeTap:function(t){var e=this;if(this.data.opts[5]){var r=t.currentTarget.dataset.i;if(this.root._table)"table"===this.getNode(r).name&&(this.root._table=void 0,this.root._remove_table=function(){e.remove(r)});if(this.root._lock)return;this.root._lock=!0,setTimeout((function(){e.root._lock=!1}),50);var i=this.getNode(r);if("td"!==i.name&&"th"!==i.name||(this.root._table=!0),3===this.data.ctrl["e"+this.i])return;if(this.root._maskTap(),this.root._edit=this,"simple"===this.data.opts[5])return;var s=r.split("_"),a=parseInt(s.pop()),c=s.join("_"),l=c?this.getNode(c).children:this.data.childs;if(this.setData(o({},"ctrl.e"+r,1)),this.root._mask.push((function(){e.setData(o({},"ctrl.e"+r,0))})),1===i.children.length&&"text"===i.children[0].type){var h=r+"_0";this.data.ctrl["e"+h]||(this.setData(o({},"ctrl.e"+h,1)),this.root._mask.push((function(){e.setData(o({},"ctrl.e"+h,0))})),this.cursor=i.children[0].text.length),this.i=h}else(this.i||"").includes(r)||(this.i=r+"_");var p=this.root._getItem(i,0!==a,a!==l.length-1);this.root._tooltip({top:n(t),items:p,success:function(o){if(console.log("tapIndex:",o),"大小"===p[o]){var s=i.attrs.style||"",h=s.match(/;font-size:([0-9]+)px/);h=h?parseInt(h[1]):16,e.root._slider({min:10,max:30,value:h,top:n(t),changing:function(o){Math.abs(o-h)>2&&(e.changeStyle("font-size",r,o+"px",h+"px"),h=t.detail.value)},change:function(t){t!==h&&e.changeStyle("font-size",r,t+"px",h+"px"),e.root._editVal("nodes["+(e.data.opts[7]+r).replace(/_/g,"].children[")+"].attrs.style",s,e.getNode(r).attrs.style)}})}else if("颜色"===p[o]){var d=e.root._getItem("color");e.root._color({top:n(t),items:d,success:function(t){var o=i.attrs.style||"",s=o.match(/;color:([^;]+)/);e.changeStyle("color",r,d[t],s?s[1]:void 0),e.root._editVal("nodes["+(e.data.opts[7]+r).replace(/_/g,"].children[")+"].attrs.style",o,e.getNode(r).attrs.style)}})}else if("上移"===p[o]||"下移"===p[o]){var u=l.slice(0),g=u[a];"上移"===p[o]?(u[a]=u[a-1],u[a-1]=g):(u[a]=u[a+1],u[a+1]=g),"_"===(c=e.data.opts[7]+c)[c.length-1]&&(c=c.slice(0,-1)),e.root._editVal("nodes"+(c?"["+c.replace(/_/g,"].children[")+"].children":""),l,u,!0)}else if("删除"===p[o])"td"!==i.name&&"th"!==i.name||!e.root._remove_table?e.remove(r):(e.root._remove_table(),e.root._remove_table=void 0);else{var f,m,_=i.attrs.style||"",v="",y=p[o];"斜体"===y?(f="font-style",m="italic"):"粗体"===y?(f="font-weight",m="bold"):"下划线"===y?(f="text-decoration",m="underline"):"居中"===y?(f="text-align",m="center"):"缩进"===y&&(f="text-indent",m="2em"),v=_.includes(f+":")?_.replace(new RegExp(f+":[^;]+"),""):_+";"+f+":"+m,e.root._editVal("nodes["+(e.data.opts[7]+r).replace(/_/g,"].children[")+"].attrs.style",_,v,!0)}}})}},mediaTap:function(t){var e=this;if(this.data.opts[5]){var r=t.target.dataset.i,i=this.getNode(r),s=this.root._getItem(i);this.root._maskTap(),this.root._edit=this,this.i=r,this.root._tooltip({top:t.target.offsetTop-30,items:s,success:function(t){switch(s[t]){case"封面":e.root.getSrc("img",i.attrs.poster||"").then((function(t){e.root._editVal("nodes["+(e.data.opts[7]+r).replace(/_/g,"].children[")+"].attrs.poster",i.attrs.poster,t instanceof Array?t[0]:t,!0)})).catch((function(){}));break;case"删除":e.remove(r);break;case"循环":case"不循环":e.root.setData(o({},"nodes["+(e.data.opts[7]+r).replace(/_/g,"].children[")+"].attrs.loop",!i.attrs.loop)),swan.showToast({title:"成功"});break;case"自动播放":case"不自动播放":e.root.setData(o({},"nodes["+(e.data.opts[7]+r).replace(/_/g,"].children[")+"].attrs.autoplay",!i.attrs.autoplay)),swan.showToast({title:"成功"})}}}),this.root._lock=!0,setTimeout((function(){e.root._lock=!1}),50)}},changeStyle:function(t,e,r,i){var s=this.getNode(e).attrs.style||"";s.includes(";"+t+":"+i)?s=s.replace(";"+t+":"+i,";"+t+":"+r):s+=";"+t+":"+r,this.root.setData(o({},"nodes["+(this.data.opts[7]+e).replace(/_/g,"].children[")+"].attrs.style",s))},noop:function(){},getNode:function(t){try{for(var e=t.split("_"),r=this.data.childs[e[0]],o=1;o<e.length;o++)r=r.children[e[o]];return r}catch(t){return{text:"",attrs:{},children:[]}}},play:function(t){var e=t.target.dataset.i,o=this.getNode(e);if(this.root.triggerEvent("play",{source:o.name,attrs:r(r({},o.attrs),{},{src:o.src[this.data.ctrl[e]||0]})}),this.root.data.pauseVideo){for(var i=!1,s=t.target.id,a=this.root._videos.length;a--;)this.root._videos[a].id===s?i=!0:this.root._videos[a].pause();if(!i){var n=swan.createVideoContext(s);n.id=s,this.root.playbackRate&&n.playbackRate(this.root.playbackRate),this.root._videos.push(n)}}},imgTap:function(t){var e=this;if(this.data.opts[5]){var r=t.target.dataset.i,i=this.getNode(r),s=this.root._getItem(i);this.root._edit=this;var c=new a(this.root);this.i=r,this.root._maskTap(),this.setData(o({},"ctrl.e"+r,1)),this.root._mask.push((function(){e.setData(o({},"ctrl.e"+r,0))})),this.root._tooltip({top:n(t),items:s,success:function(a){if("换图"===s[a])e.root.getSrc("img",i.attrs.src||"").then((function(t){e.root._editVal("nodes["+(e.data.opts[7]+r).replace(/_/g,"].children[")+"].attrs.src",i.attrs.src,c.getUrl(t instanceof Array?t[0]:t),!0)})).catch((function(){}));else if("宽度"===s[a]){var l=i.attrs.style||"",h=l.match(/max-width:([0-9]+)%/);h=h?parseInt(h[1]):100,e.root._slider({min:0,max:100,value:h,top:n(t),changing:function(t){Math.abs(t-h)>5&&(e.changeStyle("max-width",r,t+"%",h+"%"),h=t)},change:function(t){t!==h&&(e.changeStyle("max-width",r,t+"%",h+"%"),h=t),e.root._editVal("nodes["+(e.data.opts[7]+r).replace(/_/g,"].children[")+"].attrs.style",l,e.getNode(r).attrs.style)}})}else"超链接"===s[a]?e.root.getSrc("link",i.a?i.a.href:"").then((function(t){if(i.a)e.root._editVal("nodes["+(e.data.opts[7]+r).replace(/_/g,"].children[")+"].a.href",i.a.href,c.getUrl(t),!0);else{var o={name:"a",attrs:{href:c.getUrl(t)},children:[i]};i.a=o.attrs,e.root._editVal("nodes["+(e.data.opts[7]+r).replace(/_/g,"].children[")+"]",i,o,!0)}swan.showToast({title:"成功"})})).catch((function(){})):"预览图"===s[a]?e.root.getSrc("img",i.attrs["original-src"]||"").then((function(t){e.root._editVal("nodes["+(e.data.opts[7]+r).replace(/_/g,"].children[")+"].attrs.original-src",i.attrs["original-src"],c.getUrl(t instanceof Array?t[0]:t),!0),swan.showToast({title:"成功"})})).catch((function(){})):"删除"===s[a]?e.remove(r):(e.root.setData(o({},"nodes["+(e.data.opts[7]+r).replace(/_/g,"].children[")+"].attrs.ignore",!i.attrs.ignore)),swan.showToast({title:"成功"}))}}),this.root._lock=!0,setTimeout((function(){e.root._lock=!1}),50)}else{var l=this.getNode(t.target.dataset.i);if(l.a)return this.linkTap(l.a);if(l.attrs.ignore)return;if(this.root.triggerEvent("imgtap",l.attrs),this.root.data.previewImg){var h=this.root.imgList[l.i];swan.previewImage({current:h,urls:this.root.imgList})}}},imgLoad:function(t){var e,r=t.target.dataset.i;if(this.getNode(r).w)(this.data.opts[1]&&!this.data.ctrl[r]||-1===this.data.ctrl[r])&&(e=1);else if(e=t.detail.width,this.data.opts[5]){var i={},s="nodes["+(this.data.opts[7]+r).replace(/_/g,"].children[")+"].attrs.";e<150&&(i[s+"ignore"]="T"),i[s+"width"]=e.toString(),this.root.setData(i)}e&&this.setData(o({},"ctrl."+r,e)),this.checkReady()},checkReady:function(){var t=this;this.root.data.lazyLoad||(this.root.imgList._unloadimgs-=1,this.root.imgList._unloadimgs||setTimeout((function(){t.root.getRect().then((function(e){t.root.triggerEvent("ready",e)})).catch((function(){t.root.triggerEvent("ready",{})}))}),350))},linkTap:function(t){var e=this;if(this.data.opts[5]){var r=t.currentTarget.dataset.i,o=this.getNode(r),i=this.root._getItem(o);this.root._tooltip({top:n(t),items:i,success:function(t){"更换链接"===i[t]?e.root.getSrc("link",o.attrs.href).then((function(t){e.root._editVal("nodes["+(e.data.opts[7]+r).replace(/_/g,"].children[")+"].attrs.href",o.attrs.href,t,!0),swan.showToast({title:"成功"})})).catch((function(){})):e.remove(r)}})}else{var s=t.currentTarget?this.getNode(t.currentTarget.dataset.i):{},a=s.attrs||t,c=a.href;this.root.triggerEvent("linktap",Object.assign({innerText:this.root.getText(s.children||[])},a)),c&&("#"===c[0]?this.root.navigateTo(c.substring(1)).catch((function(){})):c.split("?")[0].includes("://")?this.root.data.copyLink&&swan.setClipboardData({data:c,success:function(){return swan.showToast({title:"链接已复制"})}}):swan.navigateTo({url:c,fail:function(){swan.switchTab({url:c,fail:function(){}})}}))}},mediaError:function(t){var e=t.target.dataset.i,r=this.getNode(e);if("video"===r.name||"audio"===r.name){var i=(this.data.ctrl[e]||0)+1;if(i>r.src.length&&(i=0),i<r.src.length)return this.setData(o({},"ctrl."+e,i))}else"img"===r.name&&(this.data.opts[2]&&this.setData(o({},"ctrl."+e,-1)),this.checkReady());this.root&&this.root.triggerEvent("error",{source:r.name,attrs:r.attrs,errMsg:t.detail.errMsg})}}});