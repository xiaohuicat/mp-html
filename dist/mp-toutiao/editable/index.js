"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e,n){return(e=i(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(e){var i=n(e,"string");return"symbol"==t(i)?i:i+""}function n(e,i){if("object"!=t(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,i||"default");if("object"!=t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===i?String:Number)(e)}var r=require("./config"),o=require("../parser"),s=require("./utils"),a=s.getHtmlByNodes,c=require("../mpEvent"),l=c.mpEventSend;function d(t){var i=this;console.log("vm:",t),this.vm=t,this.editHistory=[],this.editI=-1,t._mask=[];var n=function(n){var r=i.editHistory[i.editI+n];r&&(i.editI+=n,t.setData(e({},r.key,r.value)))};function s(e){if(t._edit)t._edit.insert(e);else{var i=t.data.nodes.slice(0);i.push(e),t._editVal("nodes",t.data.nodes,i,!0)}}function c(e){"string"==typeof e.src&&(e.src=[e.src]);for(var i=new o(t),n=0;n<e.src.length;n++)e.src[n]=i.getUrl(e.src[n]);s({name:"div",attrs:{style:"text-align:center"},children:[e]})}t.undo=function(){return n(-1)},t.redo=function(){return n(1)},t._editVal=function(n,r,o,s){for(;i.editI<i.editHistory.length-1;)i.editHistory.pop();for(;i.editHistory.length>30;)i.editHistory.pop(),i.editI--;var a=i.editHistory[i.editHistory.length-1];a&&a.key===n||(a&&(i.editHistory.pop(),i.editI--),i.editHistory.push({key:n,value:r}),i.editI++),i.editHistory.push({key:n,value:o}),i.editI++,s&&t.setData(e({},n,o)),l({name:"editVal",data:{path:n,oldVal:r,newVal:o,set:s}})},t._getItem=function(e,i,n){var o,s;return"color"===e?r.color:("img"===e.name?(o=r.img.slice(0),t.getSrc||(-1!==(s=o.indexOf("换图"))&&o.splice(s,1),-1!==(s=o.indexOf("超链接"))&&o.splice(s,1),-1!==(s=o.indexOf("预览图"))&&o.splice(s,1)),-1!==(s=o.indexOf("禁用预览"))&&e.attrs.ignore&&(o[s]="启用预览")):"a"===e.name?(o=r.link.slice(0),t.getSrc||-1!==(s=o.indexOf("更换链接"))&&o.splice(s,1)):"video"===e.name||"audio"===e.name?(s=(o=r.media.slice(0)).indexOf("封面"),t.getSrc||-1===s||o.splice(s,1),s=o.indexOf("循环"),e.attrs.loop&&-1!==s&&(o[s]="不循环"),s=o.indexOf("自动播放"),e.attrs.autoplay&&-1!==s&&(o[s]="不自动播放")):o="card"===e.name?r.card.slice(0):r.node.slice(0),i||-1!==(s=o.indexOf("上移"))&&o.splice(s,1),n||-1!==(s=o.indexOf("下移"))&&o.splice(s,1),o)},t._tooltip=function(e){t.setData({tooltip:{top:e.top,items:e.items}}),t._tooltipcb=e.success},t._slider=function(e){t.setData({slider:{min:e.min,max:e.max,value:e.value,top:e.top}}),t._slideringcb=e.changing,t._slidercb=e.change},t._color=function(e){t.setData({color:{items:e.items,top:e.top}}),t._colorcb=e.success},t._maskTap=function(){for(;this._mask.length;)this._mask.pop()();var t={};this.data.tooltip&&(t.tooltip=null),this.data.slider&&(t.slider=null),this.data.color&&(t.color=null),(this.data.tooltip||this.data.slider||this.data.color)&&this.setData(t)},t.insertHtml=function(e){i.inserting=!0;var n=new o(t).parse(e);i.inserting=void 0;for(var r=0;r<n.length;r++)s(n[r])},t.insertImg=function(){t.getSrc&&t.getSrc("img").then((function(e){"string"==typeof e&&(e=[e]);for(var i=new o(t),n=0;n<e.length;n++)s({name:"img",attrs:{src:i.getUrl(e[n]),style:i.tagStyle.img}})})).catch((function(){}))},t.insertLink=function(){t.getSrc&&t.getSrc("link").then((function(t){s({name:"a",attrs:{href:t},children:[{type:"text",text:t}]})})).catch((function(){}))},t.insertTable=function(t,e){for(var i={name:"table",attrs:{style:"display:table;width:100%;margin:10px 0;text-align:center;border-spacing:0;border-collapse:collapse;border:1px solid gray"},children:[]},n=0;n<t;n++){for(var r={name:"tr",attrs:{},children:[]},o=0;o<e;o++)r.children.push({name:"td",attrs:{style:"padding:2px;border:1px solid gray"},children:[{type:"text",text:""}]});i.children.push(r)}s(i)},t.insertVideo=function(){t.getSrc&&t.getSrc("video").then((function(t){c({name:"video",attrs:{controls:"T"},src:t})})).catch((function(){}))},t.insertAudio=function(){t.getSrc&&t.getSrc("audio").then((function(t){var e;t.src?(e=t.src,t.src=void 0):(e=t,t={}),t.controls="T",c({name:"audio",attrs:t,src:e})})).catch((function(){}))},t.insertText=function(){s({name:"p",attrs:{},children:[{type:"text",text:""}]})},t.clear=function(){t._maskTap(),t._edit=void 0,t.setData({nodes:[{name:"p",attrs:{},children:[{type:"text",text:""}]}]})},t.getContent=function(){for(var e=a(t.data.nodes),i=t.plugins.length;i--;)t.plugins[i].onGetContent&&(e=t.plugins[i].onGetContent(e)||e);return e}}d.prototype.onUpdate=function(t,e){var i=this;this.vm.data.editable&&(this.vm._maskTap(),e.entities.amp="&",this.inserting||(this.vm._edit=void 0,t||setTimeout((function(){i.vm.setData({nodes:[{name:"p",attrs:{},children:[{type:"text",text:""}]}]})}),0)))},d.prototype.onParse=function(t){!this.vm.data.editable||"td"!==t.name&&"th"!==t.name||this.vm.getText(t.children)||t.children.push({type:"text",text:""})},module.exports=d;